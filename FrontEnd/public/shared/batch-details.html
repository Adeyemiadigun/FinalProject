<!DOCTYPE html>
<html lang="en" x-data="batchDetailsPage()" x-init="init()" x-cloak>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Details | Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="sidebar-placeholder"></div>

  <div class="md:ml-64 p-6 space-y-6">
    <div id="navbar-placeholder"></div>

    <!-- Header -->
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold">Batch Details: <span x-text="batch.name"></span></h2>
      <a href="/public/admin/batches.html" class="text-indigo-600 hover:underline text-sm">â† Back to Batches</a>
    </div>

    <!-- Metric Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-gray-500">ğŸ“ Students</div>
        <div class="text-lg font-semibold" x-text="batch.totalStudents"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-gray-500">ğŸ“ Assessments</div>
        <div class="text-lg font-semibold" x-text="batch.totalAssessments"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-gray-500">ğŸ¯ Pass Rate</div>
        <div class="text-lg font-semibold" x-text="batch.passRate + '%'"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-gray-500">ğŸ§® Average Score</div>
        <div class="text-lg font-semibold" x-text="batch.averageScore + '%'"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-gray-500">ğŸ“Š Completion Rate</div>
        <div class="text-lg font-semibold" x-text="batch.completionRate + '%'"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-gray-500">ğŸ•’ Avg. Time</div>
        <div class="text-lg font-semibold" x-text="batch.averageCompletionTime"></div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">ğŸ“ˆ Performance Trend (by Assessment)</h3>
        <canvas id="performanceTrendChart"></canvas>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">ğŸ“¬ Submissions per Assessment</h3>
        <canvas id="submissionChart"></canvas>
      </div>
    </div>

    <!-- Student List -->
    <div class="bg-white p-4 rounded shadow">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-medium">Students in Batch</h3>
        <div class="text-sm text-gray-500" x-show="students.totalPages > 0">
          Page <span x-text="students.currentPage"></span> of <span x-text="students.totalPages"></span>
        </div>
      </div>
      <table class="w-full text-sm">
        <thead class="bg-gray-50 text-left">
          <tr>
            <th class="p-2">Name</th>
            <th class="p-2">Email</th>
            <th class="p-2">Status</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="student in students.items" :key="student.id">
            <tr class="border-t">
              <td class="p-2">
                <a :href="`/public/shared/student-details.html?id=${student.id}`" class="text-indigo-600 hover:underline" x-text="student.fullName"></a>
              </td>
              <td class="p-2" x-text="student.email"></td>
              <td class="p-2">
                <span :class="student.status ? 'text-green-600' : 'text-red-600'" class="font-semibold"
                  x-text="student.status ? 'Active' : 'Inactive'"></span>
              </td>
            </tr>
          </template>
          <tr x-show="!students.items || students.items.length === 0">
            <td colspan="3" class="text-center p-4 text-gray-500">No students found for this batch.</td>
          </tr>
        </tbody>
      </table>
      <div class="flex justify-between mt-4" x-show="students.totalPages > 1">
        <button @click="fetchStudents(students.currentPage - 1)" :disabled="!students.hasPreviousPage"
          class="px-3 py-1 bg-gray-200 rounded text-sm disabled:opacity-50">Previous</button>
        <button @click="fetchStudents(students.currentPage + 1)" :disabled="!students.hasNextPage"
          class="px-3 py-1 bg-gray-200 rounded text-sm disabled:opacity-50">Next</button>
      </div>
    </div>

    <!-- Assessment List -->
    <div class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-medium mb-3">Assessments for this Batch</h3>
      <table class="w-full text-sm">
        <thead class="bg-gray-50 text-left">
          <tr>
            <th class="p-2">Title</th>
            <th class="p-2">Assigned Date</th>
            <th class="p-2">Submissions</th>
            <th class="p-2">Avg Score</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="a in assessments.items" :key="a.id">
            <tr class="border-t">
              <td class="p-2"><a :href="`/public/assessments/assessment-details.html?assessmentId=${a.id}`"
                  class="text-indigo-600 hover:underline" x-text="a.title"></a></td>
              <td class="p-2" x-text="new Date(a.startDate).toLocaleDateString()"></td>
              <td class="p-2 text-center" x-text="`${a.submissions} / ${a.totalStudents}`"></td>
              <td class="p-2 text-center" x-text="a.avgScore + '%'"></td>
            </tr>
          </template>
          <tr x-show="!assessments.items || assessments.items.length === 0">
            <td colspan="4" class="text-center p-4 text-gray-500">No assessments found for this batch.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function loadComponent(id, path) {
      try {
        const res = await fetch(path);
        if (res.ok) {
          document.getElementById(id).innerHTML = await res.text();
        }
      } catch (error) {
        console.error(`Failed to load component from ${path}`, error);
      }
    }

    function batchDetailsPage() {
      return {
        batchId: null,
        token: localStorage.getItem("accessToken"),
        batch: {},
        students: { items: [], currentPage: 1, totalPages: 1, pageSize: 5, hasNextPage: false, hasPreviousPage: false },
        assessments: { items: [] },

        async init() {
          this.batchId = new URLSearchParams(window.location.search).get("id");
          if (!this.batchId) {
            alert("No Batch ID specified!");
            window.location.href = '/public/admin/batches.html';
            return;
          }

          const role = localStorage.getItem("userRole");
          const sidebar = role === "Admin" ? "/public/components/sidebar.html" : "/public/components/instructor-sidebar.html";
          const navbar = role === "Admin" ? "/public/components/nav.html" : "/public/components/instructor-nav.html";

          await loadComponent("sidebar-placeholder", sidebar);
          await loadComponent("navbar-placeholder", navbar);

          this.loadPageData();
        },

        async apiFetch(url) {
          const headers = { Authorization: `Bearer ${this.token}` };
          try {
            const response = await fetch(url, { headers });
            if (!response.ok) {
              console.error(`API Error ${response.status}: ${url}`);
              return { status: false, data: null };
            }
            return await response.json();
          } catch (error) {
            console.error(`Network error fetching ${url}:`, error);
            return { status: false, data: null };
          }
        },

        async loadPageData() {
          const API_BASE = "https://localhost:7157/api/v1";

          // Fetch primary data
          const [details, assessmentsData, trend, submissionStats] = await Promise.all([
            this.apiFetch(`${API_BASE}/Batches/${this.batchId}/details`),
            this.apiFetch(`${API_BASE}/Assessments/${this.batchId}/assessments/details`),
            this.apiFetch(`${API_BASE}/Batches/${this.batchId}/performance-trend`),
            this.apiFetch(`${API_BASE}/Batches/${this.batchId}/submission-stats`)
          ]);

          if (details.status) this.batch = details.data;
          if (assessmentsData.status) this.assessments = assessmentsData.data;

          // Fetch paginated students
          await this.fetchStudents(1);

          // Draw charts
          if (trend.status) this.drawPerformanceTrendChart(trend.data);
          if (submissionStats.status) this.drawSubmissionChart(submissionStats.data);
        },

        async fetchStudents(page = 1) {
          if (page < 1) return;
          const API_BASE = "https://localhost:7157/api/v1";
          const studentsData = await this.apiFetch(`${API_BASE}/Users/${this.batchId}/students?pageSize=5&currentPage=${page}`);
          if (studentsData.status) {
            this.students = studentsData.data;
          }
        },

        drawPerformanceTrendChart(data) {
          if (!data || !data.labels || !data.scores) return;
          const ctx = document.getElementById("performanceTrendChart").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: data.labels,
              datasets: [{
                label: "Average Score",
                data: data.scores,
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                fill: true,
                tension: 0.3,
              }],
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true, max: 100 } },
            },
          });
        },

        drawSubmissionChart(data) {
          if (!data) return;
          const ctx = document.getElementById("submissionChart").getContext("2d");
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: data.map(d => d.assessmentTitle),
              datasets: [{
                label: "Total Assigned",
                data: data.map(d => d.totalAssigned),
                backgroundColor: "#a5b4fc",
              }, {
                label: "Total Submitted",
                data: data.map(d => d.totalSubmitted),
                backgroundColor: "#4f46e5",
              }],
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } },
            },
          });
        },
      };
    }
  </script>
</body>

</html>