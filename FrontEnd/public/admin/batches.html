<!DOCTYPE html>
<html lang="en" x-data="batchPage()" x-init="init()">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batches | Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="/public/assets/js/admin/batch.js" defer></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }

    .skeleton {
      @apply animate-pulse bg-gray-200 rounded;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="sidebar-placeholder"></div>
  <div class="md:ml-64 p-6 space-y-6 relative">
    <div id="navbar-placeholder"></div>

    <!-- Header & Actions -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Batches</h2>
      <div class="flex gap-4">
        <select class="px-3 py-2 rounded border bg-white text-sm" x-model="selectedBatchId"
          @change="fetchMetrics(); fetchTrend()">
          <option value="">All Batches</option>
          <template x-for="batch in batchOptions" :key="batch.id">
            <option :value="batch.id" x-text="batch.name + ' ' + batch.batchNumber"></option>
          </template>
        </select>
        <button @click="showCreateModal = true"
          class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700">+ New Batch</button>
      </div>
    </div>

    <!-- Metric Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
      <template x-if="isLoading">
        <template x-for="i in 4">
          <div class="bg-white p-4 rounded shadow space-y-2">
            <div class="h-4 w-1/2 skeleton"></div>
            <div class="h-6 w-1/3 skeleton"></div>
          </div>
        </template>
      </template>
      <template x-if="!isLoading && metrics">
        <div class="contents">
          <div class="bg-white p-4 rounded shadow">
            <div class="text-sm text-gray-500">ðŸŽ¯ Pass Rate</div>
            <div class="text-lg font-semibold" x-text="metrics.passRate + '%'"></div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <div class="text-sm text-gray-500">ðŸ§® Average Score</div>
            <div class="text-lg font-semibold" x-text="metrics.averageScore + '%'"></div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <div class="text-sm text-gray-500">ðŸ“Š Completion Rate</div>
            <div class="text-lg font-semibold" x-text="metrics.completionRate + '%'"></div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <div class="text-sm text-gray-500">ðŸ•’ Avg. Assessment Time</div>
            <div class="text-lg font-semibold" x-text="metrics.averageCompletionTime"></div>
          </div>
        </div>
      </template>
    </div>

    <!-- Filters -->
    <div class="flex gap-4 items-end">
      <div>
        <label class="block text-sm text-gray-600">From</label>
        <input type="date" x-model="filters.fromDate" class="border rounded px-3 py-2 text-sm" />
      </div>
      <div>
        <label class="block text-sm text-gray-600">To</label>
        <input type="date" x-model="filters.toDate" class="border rounded px-3 py-2 text-sm" />
      </div>
      <button @click="fetchTrend()"
        class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Apply</button>
    </div>
    <button @click="filters.fromDate=''; filters.toDate=''; fetchTrend()"
      class="text-sm text-gray-500 underline">Reset</button>

    <!-- Charts -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-medium mb-2">ðŸ“ˆ Performance Trend</h3>
        <template x-if="isLoading">
          <div class="h-40 skeleton rounded"></div>
        </template>
        <template x-if="!isLoading">
          <canvas id="trendChart"></canvas>
        </template>
      </div>
    
    </div>

    <!-- Batch List Table -->
    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-medium text-lg mb-2">ðŸ“‹ Batch List</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2 text-left">Batch Name</th>
              <th class="p-2">Students</th>
              <th class="p-2">Assessments</th>
              <th class="p-2">Pass Rate</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="isLoading">
              <tr>
                <td colspan="4">
                  <div class="space-y-2">
                    <div class="h-4 w-full skeleton"></div>
                    <div class="h-4 w-3/4 skeleton"></div>
                    <div class="h-4 w-1/2 skeleton"></div>
                  </div>
                </td>
              </tr>
            </template>
            <template x-if="!isLoading && batchList.length === 0">
              <tr>
                <td colspan="4" class="text-center text-gray-500 py-4">No batches found.</td>
              </tr>
            </template>
            <template x-if="!isLoading">
              <template x-for="batch in batchList" :key="batch.id">
                <tr class="border-t">
                  <td class="p-2" x-text="batch.name"></td>
                  <td class="p-2 text-center" x-text="batch.studentCount"></td>
                  <td class="p-2 text-center" x-text="batch.assessmentCount"></td>
                  <td class="p-2 text-center" x-text="(batch.passRate ?? 0).toFixed(1) + '%'"></td>
                </tr>
              </template>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Create Modal -->
    <div x-cloak x-show="showCreateModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
      <div @click.outside="showCreateModal = false" class="bg-white w-full max-w-md rounded-lg p-6 space-y-6 shadow-xl">
        <h2 class="text-xl font-semibold">Create New Batch</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Batch Name</label>
            <input type="text" x-model="newBatch.name" class="w-full px-3 py-2 border rounded text-sm"
              placeholder="e.g. Cohort Alpha" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Batch Number</label>
            <input type="number" x-model="newBatch.number" class="w-full px-3 py-2 border rounded text-sm" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="showCreateModal = false" class="px-4 py-2 text-sm border rounded">Cancel</button>
          <button @click="createBatch"
            class="bg-indigo-600 text-white px-4 py-2 text-sm rounded hover:bg-indigo-700">Create</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>