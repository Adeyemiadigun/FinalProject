<!DOCTYPE html>
<html lang="en" x-data="questionsPage()" x-init="init()">

<head>
  <meta charset="UTF-8" />
  <title>Assessment Questions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="sidebar-placeholder"></div>
  <div class="md:ml-64 p-6 space-y-6" x-cloak>
    <div id="navbar-placeholder"></div>

    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Questions for Assessment: <span x-text="assessmentTitle"></span></h2>
      <button @click="showCreateModal = true" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">âž• Add
        Question</button>
    </div>

    <!-- Question List -->
    <div class="bg-white p-4 rounded shadow">
      <table class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 text-left">#</th>
            <th class="p-2 text-left">Question</th>
            <th class="p-2 text-left">Type</th>
            <th class="p-2 text-left">Marks</th>
            <th class="p-2 text-left">Order</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(q, index) in questions" :key="q.id">
            <tr class="border-t align-top">
              <td class="p-2" x-text="index + 1"></td>
              <td class="p-2">
                <div class="font-semibold" x-text="q.questionText"></div>
              </td>
              <td class="p-2" x-text="q.questionType"></td>
              <td class="p-2" x-text="q.marks"></td>
              <td class="p-2" x-text="q.order"></td>
              <td class="p-2 space-x-2">
                <button @click="openEditModal(index)" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button @click="deleteQuestion(q.id)" class="text-red-600 hover:underline text-sm">Delete</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Modal for Create/Edit -->
    <div x-show="showCreateModal || showEditModal" x-transition
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.outside="closeModals()"
      style="display: none;">
      <div class="bg-white w-full max-w-2xl p-6 rounded shadow">
        <h3 class="text-xl font-bold mb-4" x-text="showCreateModal ? 'Create Question' : 'Edit Question'"></h3>

        <div class="mb-4">
          <label class="font-semibold block">Question Text</label>
          <textarea x-model="questionForm.questionText" class="w-full border rounded px-4 py-2" rows="3"></textarea>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4">
          <div>
            <label class="font-semibold block">Marks</label>
            <input type="number" x-model="questionForm.marks" class="w-full border rounded px-2 py-1" />
          </div>
          <div>
            <label class="font-semibold block">Order</label>
            <input type="number" x-model="questionForm.order" class="w-full border rounded px-2 py-1" />
          </div>
          <div>
            <label class="font-semibold block">Type</label>
            <select x-model="questionForm.questionType" class="w-full border rounded px-2 py-1"
              :disabled="showEditModal">
              <option value="">Select</option>
              <option value="MCQ">MCQ</option>
              <option value="Objective">Objective</option>
              <option value="Coding">Coding</option>
            </select>
          </div>
        </div>

        <div class="text-right space-x-2">
          <button @click="closeModals"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
          <button @click="submitQuestion"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function questionsPage() {
      return {
        assessmentId: null,
        assessmentTitle: '',
        questions: [],
        showCreateModal: false,
        showEditModal: false,
        editIndex: null,
        questionForm: {
          questionText: '',
          questionType: '',
          marks: 1,
          order: 1,
          options: [],
          testCases: [],
          answer: { answerText: '' }
        },

        async init() {
          const params = new URLSearchParams(window.location.search);
          this.assessmentId = params.get('assessmentId');
          this.assessmentTitle = `Assessment #${this.assessmentId ?? 'N/A'}`;
          await this.loadQuestions();
        },

        async loadQuestions() {
          const res = await fetch(`/api/instructor/assessment/${this.assessmentId}/questions`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await res.json();
          this.questions = data?.data || [];
        },

        openEditModal(index) {
          this.editIndex = index;
          this.questionForm = JSON.parse(JSON.stringify(this.questions[index]));
          this.showEditModal = true;
        },

        async submitQuestion() {
          const payload = {
            questionText: this.questionForm.questionText,
            questionType: this.questionForm.questionType,
            marks: this.questionForm.marks,
            order: this.questionForm.order,
            options: this.questionForm.options,
            testCases: this.questionForm.testCases,
            answer: this.questionForm.answer
          };

          const url = this.showEditModal
            ? `/api/v/questions/${this.questions[this.editIndex].id}`
            : `/api/instructor/assessment/${this.assessmentId}/questions`;

          const method = this.showEditModal ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(this.showEditModal ? payload : [payload])
          });

          if (res.ok) {
            await this.loadQuestions();
            this.closeModals();
          } else {
            alert('Failed to submit question');
          }
        },

        async deleteQuestion(questionId) {
          if (!confirm('Are you sure you want to delete this question?')) return;
          const res = await fetch(`/api/v/questions/${questionId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (res.ok) {
            this.questions = this.questions.filter(q => q.id !== questionId);
          } else {
            alert('Failed to delete question');
          }
        },

        closeModals() {
          this.showCreateModal = false;
          this.showEditModal = false;
          this.questionForm = {
            questionText: '',
            questionType: '',
            marks: 1,
            order: 1,
            options: [],
            testCases: [],
            answer: { answerText: '' }
          };
        }
      };
    }
  </script>
</body>

</html>