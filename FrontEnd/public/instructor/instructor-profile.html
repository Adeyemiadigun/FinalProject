<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Instructor Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/utils/api.js"></script> <!-- adjust path to your api utils -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100">

  <div x-data="instructorProfile()" x-init="fetchInstructor()" class="p-6 max-w-6xl mx-auto">

    <!-- Skeleton Loader -->
    <template x-if="loading">
      <div class="space-y-4 animate-pulse">
        <div class="h-16 w-16 bg-gray-300 rounded-full"></div>
        <div class="h-6 bg-gray-300 rounded w-1/3"></div>
        <div class="grid grid-cols-4 gap-4">
          <div class="h-24 bg-gray-300 rounded"></div>
          <div class="h-24 bg-gray-300 rounded"></div>
          <div class="h-24 bg-gray-300 rounded"></div>
          <div class="h-24 bg-gray-300 rounded"></div>
        </div>
      </div>
    </template>

    <!-- Profile Info -->
    <template x-if="!loading">
      <div>
        <div class="flex items-center space-x-4 bg-white p-4 rounded shadow">
          <div
            class="h-20 w-20 rounded-full bg-blue-600 text-white flex items-center justify-center text-2xl font-bold">
            <span x-text="instructor.initials"></span>
          </div>
          <div>
            <h2 class="text-2xl font-bold" x-text="instructor.fullName"></h2>
            <p class="text-gray-600" x-text="instructor.email"></p>
            <p class="text-gray-500 text-sm">Joined: <span x-text="formatDate(instructor.dateCreated)"></span></p>
          </div>
          <div class="ml-auto">
            <button @click="openEditModal" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              Edit Profile
            </button>
          </div>
        </div>

        <!-- Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
          <div class="p-4 bg-white rounded shadow text-center">
            <p class="text-gray-500">Assessments</p>
            <h3 class="text-xl font-bold" x-text="metrics.assessments"></h3>
          </div>
          <div class="p-4 bg-white rounded shadow text-center">
            <p class="text-gray-500">Students</p>
            <h3 class="text-xl font-bold" x-text="metrics.students"></h3>
          </div>
          <div class="p-4 bg-white rounded shadow text-center">
            <p class="text-gray-500">Avg. Score</p>
            <h3 class="text-xl font-bold text-green-600" x-text="metrics.avgScore + '%'"></h3>
          </div>
          <div class="p-4 bg-white rounded shadow text-center">
            <p class="text-gray-500">Pass Rate</p>
            <h3 class="text-xl font-bold text-blue-600" x-text="metrics.passRate + '%'"></h3>
          </div>
        </div>

        <!-- Assessments Table -->
        <div class="mt-8 bg-white shadow rounded p-4">
          <h3 class="text-lg font-bold mb-4">Assessments</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-left border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2">Title</th>
                  <th class="p-2">Created</th>
                  <th class="p-2">Students</th>
                  <th class="p-2">Submissions</th>
                  <th class="p-2">Avg Score</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="a in assessments" :key="a.id">
                  <tr class="border-t">
                    <td class="p-2" x-text="a.title"></td>
                    <td class="p-2" x-text="formatDate(a.createdAt)"></td>
                    <td class="p-2" x-text="a.totalStudents"></td>
                    <td class="p-2" x-text="a.submissions"></td>
                    <td class="p-2" x-text="a.avgScore + '%'"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </template>

    <!-- Edit Modal -->
    <div x-show="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      style="display:none">
      <div class="bg-white rounded p-6 w-full max-w-md">
        <h3 class="text-lg font-bold mb-4">Edit Profile</h3>
        <form @submit.prevent="submitUpdate">
          <div class="mb-3">
            <input type="text" x-model="editForm.name" placeholder="Full Name" class="w-full border p-2 rounded"
              :class="{'border-red-500': errors.name}">
            <p x-show="errors.name" class="text-red-500 text-sm" x-text="errors.name"></p>
          </div>
          <div class="mb-3">
            <input type="email" x-model="editForm.email" placeholder="Email" class="w-full border p-2 rounded"
              :class="{'border-red-500': errors.email}">
            <p x-show="errors.email" class="text-red-500 text-sm" x-text="errors.email"></p>
          </div>
          <div class="mb-3">
            <input type="password" x-model="editForm.currentPassword" placeholder="Current Password"
              class="w-full border p-2 rounded">
          </div>
          <div class="mb-3">
            <input type="password" x-model="editForm.newPassword" placeholder="New Password"
              class="w-full border p-2 rounded">
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" @click="closeEditModal" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function instructorProfile() {
      return {
        loading: true,
        instructor: {},
        metrics: { assessments: 0, students: 0, avgScore: 0, passRate: 0 },
        assessments: [],
        showEditModal: false,
        editForm: { name: '', email: '', currentPassword: '', newPassword: '' },
        errors: {},

        async fetchInstructor() {
          try {
            const res = await api.get("/Users/instructor/me"); // adjust endpoint
            const data = await res.json();
            if (!res.ok) throw data;

            this.instructor = {
              fullName: data.fullName,
              email: data.email,
              dateCreated: data.dateCreated,
              initials: data.fullName.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase()
            };
            this.metrics = data.metrics || { assessments: 0, students: 0, avgScore: 0, passRate: 0 };
            this.assessments = data.assessments || [];
            this.editForm.name = data.fullName;
            this.editForm.email = data.email;
          } catch (err) {
            Swal.fire("Error", err.message || "Failed to load instructor", "error");
          } finally {
            this.loading = false;
          }
        },

        async submitUpdate() {
          this.errors = {};
          if (!this.editForm.name) this.errors.name = "Name is required";
          if (!this.editForm.email) this.errors.email = "Email is required";
          if (Object.keys(this.errors).length) return;

          try {
            const res = await api.put("/Users/update", {
              fullName: this.editForm.name,
              email: this.editForm.email,
              currentPassword: this.editForm.currentPassword || null,
              newPassword: this.editForm.newPassword || null,
            });
            const json = await res.json();
            if (!res.ok) throw json;
            Swal.fire("Success", "Profile updated successfully", "success");
            this.instructor.fullName = this.editForm.name;
            this.instructor.email = this.editForm.email;
            this.closeEditModal();
          } catch (err) {
            Swal.fire("Error", err.message || "Failed to update profile", "error");
          }
        },

        openEditModal() {
          this.showEditModal = true;
        },
        closeEditModal() {
          this.showEditModal = false;
        },
        formatDate(d) {
          return new Date(d).toLocaleDateString();
        }
      }
    }
  </script>

</body>

</html>